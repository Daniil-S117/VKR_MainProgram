# Оценка процесса

Здесь мы предлагаем несколько скриптов для оценки конвейера на тестовом наборе данных.

Для этого выполните следующие шаги.

## Создание истинных аннотаций

Создание файла истинных аннотаций. Для этого просто запустите скрипт `evaluation_file_gen.py`. В качестве аргумента `--path` укажите путь к папке test_images. Убедитесь, что изображения находятся не непосредственно в этой папке, а в подкаталоге `test_images/images`.

```shell
python evaluation/evaluation_file_gen.py --path path/to/test_images
```

Это создаст скелетный json-файл, в котором для каждого изображения вы вручную заполните показания, единицы измерения и диапазон датчика. Диапазон нужен для вычисления относительной погрешности. Для этого укажите абсолютную длину шкалы. Например, если шкала идет от -2 до 5, диапазон будет равен 7.

## Прогоните тестовые изображения через конвейеры, чтобы получить результаты.

Для этого используйте команду для выполнения конвейера:

```shell
python pipeline.py --detection_model path/to/detection_model --segmentation_model /path/to/segmentation_model --key_point_model path/to/key_point_model --base_path path/to/results --debug --eval --input path/to/test_image_folder/images
```

Это создаст папку run в указанной папке results. В папке run вы получите по одной папке для каждого изображения.

## Запуск сценария оценки

Получив истинные аннотации и результаты работы конвейера, мы можем сравнить их с помощью сценария оценки:

```shell
python evaluation/evaluation.py --run_path path/to/run_path --true_readings_path path/to/true_readings_file
```

Здесь `run_path` - это папка, созданная скриптом `image_function.py`.

Запуск этого скрипта делает две вещи. Во-первых, он суммирует отдельные результаты изображений в папке run в один файл, который сохраняет в папке run.
Во-вторых, он генерирует файл `evaluation.json` в папке run, который суммирует результаты.

## Улучшение тестового набора

Для наших экспериментов мы улучшили набор тестовых изображений, повернув их случайным образом. Мы сделали это с помощью блокнота `rotate_test_imgs.ipynb`.

## Полная оценка

Сначала промаркируйте набор данных с помощью `label-studio` <https://labelstud.io/>. Для этого вам нужно создать 3 разных проекта: один для ключевых точек, один для ограничительных рамок и один для сегментации. Для сегментации выбирайте метки с полигонами. Название меток очень важно и должно соответствовать следующему:

Для ограничительных рамок:
- Gauge
- Цифры OCR
- OCR Единица

Для ключевых точек:
- Средняя выемка
- Начальная насечка
- Конечная насечка

Для сегментации:
- стрелка

При экспорте этих данных с помощью label-studio вы получите 3 json-файла, по одному для каждого проекта. Предоставьте их при запуске скрипта full_evaluation.

Чтобы запустить сценарий full_evaluation, выполните:

```shell
python evaluation/full_evaluation.py --bbox_true_path path/to/bbox.json --keypoint_true_path path/to/keypoint.json --segmentation_true_path path/to/seg.json --run_path path/to/run_path
```
